{% extends "base.html" %} {% block content %}
<style>
  .dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 3rem;
    padding: 2rem;
    background: linear-gradient(
      135deg,
      rgba(38, 59, 247, 0.1) 0%,
      rgba(90, 107, 250, 0.1) 100%
    );
    border-radius: 16px;
    border: 1px solid rgba(38, 59, 247, 0.2);
  }

  .dashboard-title {
    font-size: 2.2rem;
    font-weight: 700;
    margin: 0;
    color: var(--text);
  }

  .user-info-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.5rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
  }

  .user-avatar {
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, var(--primary), var(--primary-light));
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
  }

  .user-details {
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
  }

  .user-name {
    font-weight: 600;
    color: var(--text);
    margin: 0;
  }

  .user-role {
    font-size: 0.65rem;
    color: var(--muted);
    text-transform: lowercase;
  }

  .section-title {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .section-title i {
    color: var(--primary);
  }

  /* Benefits Gallery */
  .benefits-gallery {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 3rem;
  }

  .benefit-card {
    background: var(--surface);
    border: 2px solid var(--border);
    border-radius: 16px;
    padding: 2rem;
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .benefit-card::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, var(--primary), var(--primary-light));
    transform: scaleX(0);
    transition: transform 0.3s ease;
  }

  .benefit-card:hover::before {
    transform: scaleX(1);
  }

  .benefit-card:hover {
    transform: translateY(-8px);
    border-color: var(--primary);
    box-shadow: 0 12px 40px rgba(38, 59, 247, 0.25);
  }

  .benefit-card.disabled {
    opacity: 0.5;
    pointer-events: none;
  }

  .benefit-card.disabled .benefit-icon {
    background: linear-gradient(135deg, #4a5568, #718096);
  }

  .benefit-icon {
    width: 70px;
    height: 70px;
    background: linear-gradient(135deg, var(--primary), var(--primary-light));
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1.5rem;
    font-size: 2rem;
    color: white;
    transition: all 0.3s ease;
  }

  .benefit-card:hover .benefit-icon {
    transform: scale(1.1) rotate(5deg);
  }

  .benefit-name {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text);
  }

  .benefit-description {
    font-size: 0.9rem;
    color: var(--muted);
    margin-bottom: 1.5rem;
  }

  .btn-request {
    width: 100%;
    padding: 0.75rem;
    border-radius: 10px;
    font-weight: 600;
    border: none;
    background: var(--primary);
    color: white;
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .btn-request:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(38, 59, 247, 0.4);
  }

  .btn-request:disabled {
    background: #4a5568;
    cursor: not-allowed;
    transform: none;
  }
  .btn-consumir {
    padding: 0.4rem 1rem;
    border-radius: 8px;
    font-size: 0.85rem;
    font-weight: 600;
    border: none;
    background: var(--success);
    color: white;
    transition: all 0.3s ease;
  }

  .btn-consumir:hover {
    background: #17a864;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(31, 191, 117, 0.4);
  }
  .status-badge {
    position: absolute;
    top: 1rem;
    right: 1rem;
    padding: 0.35rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
  }

  .status-badge.requested {
    background: rgba(244, 185, 66, 0.2);
    color: #ffe9c2;
  }

  /* History Table */
  .history-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 2rem;
    margin-top: 2rem;
  }

  .table-custom {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
  }

  .table-custom thead th {
    background: rgba(38, 59, 247, 0.1);
    color: var(--primary-light);
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.85rem;
    padding: 1rem;
    border: none;
  }

  .table-custom thead th:first-child {
    border-radius: 10px 0 0 0;
  }

  .table-custom thead th:last-child {
    border-radius: 0 10px 0 0;
  }

  .table-custom tbody tr {
    transition: all 0.2s ease;
  }

  .table-custom tbody tr:hover {
    background: rgba(38, 59, 247, 0.05);
  }

  .table-custom tbody td {
    padding: 1rem;
    border-bottom: 1px solid var(--border);
    color: var(--text);
  }

  .table-custom tbody tr:last-child td {
    border-bottom: none;
  }

  .status-pill {
    display: inline-block;
    padding: 0.4rem 1rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
  }

  .status-pill.solicitado {
    background: rgba(244, 185, 66, 0.2);
    color: #ffe9c2;
  }

  .status-pill.aprobado {
    background: rgba(31, 191, 117, 0.2);
    color: #baf3d2;
  }

  .status-pill.consumido {
    background: rgba(255, 90, 119, 0.2);
    color: #ffd1d9;
  }

  .empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--muted);
  }

  .empty-state i {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
  }

  @media (max-width: 768px) {
    .dashboard-header {
      flex-direction: column;
      gap: 1rem;
      text-align: center;
    }

    .benefits-gallery {
      grid-template-columns: 1fr;
    }

    .table-custom {
      font-size: 0.9rem;
    }
  }
</style>

<div class="dashboard-header">
  <div>
    <h2 class="dashboard-title">
      <i class="bi bi-speedometer2"></i> Beneficios
    </h2>
  </div>
  <div class="user-info-card">
    <div class="user-avatar">
      <i class="bi bi-person-fill"></i>
    </div>
    <div class="user-details">
      <p class="user-name">{{ user.name }}</p>
      <span class="user-role">{{ user.email }}</span>
    </div>
  </div>
</div>

<!-- Benefits Gallery Section -->
<section>
  <h3 class="section-title">
    <i class="bi bi-grid-3x3-gap-fill"></i>
    Solicitar Beneficios
  </h3>

  <div class="benefits-gallery">
    <!-- Líquido AM -->
    <div class="benefit-card" id="card-liquido-am">
      <div class="benefit-icon">
        <i class="bi bi-cup-hot-fill"></i>
      </div>
      <h4 class="benefit-name">Líquido AM</h4>
      <p class="benefit-description">Beneficio reposición calórica.</p>
      <form method="post" onsubmit="return handleSubmit(event, 'liquido-am')">
        <input type="hidden" name="benefit_type" value="Liquido-Am" />
        <button type="submit" class="btn-request" id="btn-liquido-am">
          <i class="bi bi-check-circle-fill me-2"></i>
          Solicitar
        </button>
      </form>
    </div>

    <!-- Líquido + Complemento -->
    <div class="benefit-card" id="card-liquido-complemento">
      <div class="benefit-icon">
        <i class="bi bi-cup-straw"></i>
      </div>
      <h4 class="benefit-name">Líquido y Complemento</h4>
      <p class="benefit-description">Beneficio reposición calórica</p>
      <form
        method="post"
        onsubmit="return handleSubmit(event, 'liquido-complemento')"
      >
        <input type="hidden" name="benefit_type" value="Liquido-Complemento" />
        <button type="submit" class="btn-request" id="btn-liquido-complemento">
          <i class="bi bi-check-circle-fill me-2"></i>
          Solicitar
        </button>
      </form>
    </div>

    <!-- Almuerzo -->
    <div class="benefit-card" id="card-almuerzo">
      <div class="benefit-icon">
        <!-- <i class="bi bi-food"></i> -->
         <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-fork-knife" viewBox="0 0 16 16">
  <path d="M13 .5c0-.276-.226-.506-.498-.465-1.703.257-2.94 2.012-3 8.462a.5.5 0 0 0 .498.5c.56.01 1 .13 1 1.003v5.5a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5zM4.25 0a.25.25 0 0 1 .25.25v5.122a.128.128 0 0 0 .256.006l.233-5.14A.25.25 0 0 1 5.24 0h.522a.25.25 0 0 1 .25.238l.233 5.14a.128.128 0 0 0 .256-.006V.25A.25.25 0 0 1 6.75 0h.29a.5.5 0 0 1 .498.458l.423 5.07a1.69 1.69 0 0 1-1.059 1.711l-.053.022a.92.92 0 0 0-.58.884L6.47 15a.971.971 0 1 1-1.942 0l.202-6.855a.92.92 0 0 0-.58-.884l-.053-.022a1.69 1.69 0 0 1-1.059-1.712L3.462.458A.5.5 0 0 1 3.96 0z"/>
</svg>
      </div>
      <h4 class="benefit-name">Almuerzo</h4>
      <p class="benefit-description">Beneficio de almuerzo completo</p>
      <form method="post" onsubmit="return handleSubmit(event, 'almuerzo')">
        <input type="hidden" name="benefit_type" value="Almuerzo" />
        <button type="submit" class="btn-request" id="btn-almuerzo">
          <i class="bi bi-check-circle-fill me-2"></i>
          Solicitar
        </button>
      </form>
    </div>

    <!-- Líquido PM -->
    <div class="benefit-card" id="card-liquido-pm">
      <div class="benefit-icon">
        <i class="bi bi-cup-fill"></i>
      </div>
      <h4 class="benefit-name">Líquido PM</h4>
      <p class="benefit-description">Beneficio reposición calórica</p>
      <form method="post" onsubmit="return handleSubmit(event, )">
        <input type="hidden" name="benefit_type" value="Liquido Pm" />
        <button type="submit" class="btn-request" id="btn-liquido-pm">
          <i class="bi bi-check-circle-fill me-2"></i>
          Solicitar
        </button>
      </form>
    </div>
  </div>

  <div class="alert alert-info">
    <i class="bi bi-info-circle-fill me-2"></i>
    <strong>Nota:</strong> Solo puedes solicitar cada beneficio una vez por día.
    Las tarjetas se deshabilitarán automáticamente después de hacer la
    solicitud.
  </div>
</section>

<!-- History Section -->
<section class="history-card">
  <h3 class="section-title">
    <i class="bi bi-clock-history"></i>
    Historial de Solicitudes
  </h3>

  {% if requests_list and requests_list|length > 0 %}
  <div class="table-responsive">
    <table class="table-custom">
      <thead>
        <tr>
          <th>Tipo de Beneficio</th>
          <th>Estado</th>
          <th>Fecha de Solicitud</th>
          <th>Acción</th>
        </tr>
      </thead>
      <tbody id="requestsTable2">
        {% for req in requests_list %}
        <tr>
          <td>
            <i
              class="bi bi-{% if req.benefit_type == 'Almuerzo' %}fork-knife{% else %}cup-fill{% endif %} me-2"
            ></i>
            {{ req.benefit_type }}
          </td>
          <td>
            <span class="status-pill {{ req.status.lower() }}">
              {{ req.status }}
            </span>
          </td>
          <td>{{req.Fecha if req.Fecha else 'N/A' }}</td>
          <td>
            {% if req.status == "Solicitado" %}
            <button
              class="btn-consumir"
              onclick="consumirSolicitud('{{ req.id }}','{{API}}')"
            >
              <i class="bi bi-trash-fill me-1"></i> Eliminar
            </button>
            {% else %}
            <button
              class="btn-consumir"
              onclick="consumirSolicitud('{{ req.id }}','{{API}}')"
            >
              <i class="bi bi-lock-fill me-1"></i> Consumido
            </button>
            {% endif %}
          </td>
        </tr>

        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="empty-state">
    <i class="bi bi-inbox"></i>
    <p>Aún no tienes solicitudes de beneficios.</p>
    <p class="text-muted-custom">
      Comienza solicitando tu primer beneficio arriba.
    </p>
  </div>
  {% endif %}
</section>

<script>
  // Al cargar la página, verificar qué beneficios ya fueron solicitados hoy
  document.addEventListener("DOMContentLoaded", function () {
    const rows = document.querySelectorAll("#requestsTable2 tr");
    rows.forEach((row) => {
      const today = new Date().toISOString().split("T")[0];
      const [year, month, day] = today.split("-");
      const today_formatted = `${year}-${month}-${day}`;
      const fechaCell = row.cells[2]; // Columna de fecha
      if (fechaCell) {
        const fechaText = fechaCell.textContent.trim().toString();
        if (fechaText === today_formatted) {
          const benefitType = row.cells[0].textContent
            .trim()
            .toLowerCase()
            .replace(/ /g, "-");
          const card = document.getElementById("card-" + benefitType);
          const button = document.getElementById("btn-" + benefitType);
          if (card && button) {
            card.classList.add("disabled");
            button.disabled = true;
            button.innerHTML =
              '<i class="bi bi-check-circle-fill me-2"></i>Ya solicitado';

            // Agregar badge de solicitado
            if (!card.querySelector(".status-badge")) {
              const badge = document.createElement("span");
              badge.className = "status-badge requested";
              badge.innerHTML = '<i class="bi bi-check-lg"></i> Solicitado';
              card.appendChild(badge);
            }
          }
        }
      }
    });
    // Función para manejar el envío del formulario y deshabilitar la tarjeta
    function handleSubmit(event, benefitId) {
      const card = document.getElementById("card-" + benefitId);
      const button = document.getElementById("btn-" + benefitId);

      // Deshabilitar el botón inmediatamente para evitar doble clic
      button.disabled = true;
      button.innerHTML =
        '<i class="bi bi-hourglass-split me-2"></i>Procesando...';

      // Guardar en sessionStorage que este beneficio fue solicitado hoy
      const today = new Date().toDateString();
      sessionStorage.setItem("benefit-" + benefitId + "-date", today);

      // El formulario se enviará normalmente
      return true;
    }
  });

  //Delete request function
  async function consumirSolicitud(requestId, API) {
    try {
      const response = await fetch(`${API}/request/${requestId}`, {
        method: "DELETE",
        headers: {
          Authorization: "Bearer {{ session.get('access_token') }}",
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ status: "Eliminado" }),
      });
      if (response.ok) {
        // alert("Solicitud eliminada correctamente.");
        location.reload();
      } else {
        const error = await response.json();
        // alert("Error: " + error.detail);
      }
    } catch (err) {
      // alert("Error de conexión: " + err);
    }
  }
  //Inactivar botón eliminar si el estado no es 'Solicitado' y cambiar de color
  document.addEventListener("DOMContentLoaded", function () {
    const rows = document.querySelectorAll("#requestsTable2 tr");
    rows.forEach((row) => {
      const actionCell = row.cells[3]; // Columna de acción
      const statusCell = row.cells[1]; // Columna de estado
      if (actionCell && statusCell) {
        const statusText = statusCell.textContent.trim();
        if (statusText !== "Solicitado") {
          const button = actionCell.querySelector(".btn-consumir");
          if (button) {
            button.disabled = true;
            button.style.background = "#6c757d"; // Cambiar color a gris
            button.style.cursor = "not-allowed";
            button.innerHTML =
              '<i class="bi bi-x-circle-fill me-1"></i> No válido';
          }
        }
      }
    });
  });
</script>
{% endblock %}
